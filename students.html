<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Students</title>
<style>
  body{font-family:Segoe UI, Roboto, Arial; margin:0; background:#f7f8fb}
  header{padding:16px;text-align:center;background:linear-gradient(90deg,#3b82f6,#06b6d4);color:white}
  .controls{display:flex;gap:8px;justify-content:center;padding:12px;flex-wrap:wrap}
  .container{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;padding:18px}
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08);transition:transform .18s}
  .card:hover{transform:translateY(-6px)}
  .photo{width:100%;height:200px;object-fit:cover}
  .signature{height:60px;object-fit:contain;width:100%;background:#fafafa;padding:6px;display:flex;align-items:center;justify-content:center}
  .info{padding:10px;text-align:center}
  .likebar{display:flex;justify-content:center;gap:8px;align-items:center;padding-bottom:10px}
  button.icon{border:none;background:#eee;padding:8px 10px;border-radius:8px;cursor:pointer}
  #scrollTopBtn{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px;border-radius:50%;display:none}
  .badge{font-weight:bold;padding:2px 6px;border-radius:12px;background:#f1f5f9}
  select, input{padding:8px;border-radius:8px;border:1px solid #d1d5db}
</style>
</head>
<body>
<header><h1>Our College Students</h1></header>

<div class="controls">
  <select id="filterMode">
    <option value="">All Students (random)</option>
    <option value="most-liked">Most Liked</option>
    <option value="most-disliked">Most Disliked</option>
  </select>

  <select id="yearFilter">
    <option value="">Filter by Year</option>
  </select>

  <select id="semFilter">
    <option value="">Filter by Semester</option>
  </select>

  <button id="reloadBtn">Reload Counts</button>
</div>

<div id="container" class="container"></div>

<button id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

<script>
const STUDENTS_JSON = "students.json";
const CHUNK = 50;
const GS_WEBAPP_URL = "REPLACE_WITH_YOUR_APPS_SCRIPT_URL";
const WRITE_TOKEN = "";

let students = [];
let rendered = 0;
let counts = {}; // {id: {likes: n, dislikes: m}}

async function init() {
  const resp = await fetch(STUDENTS_JSON);
  students = await resp.json();

  // populate year/sem options
  const years = Array.from(new Set(students.map(s=>s.year))).sort();
  const sems = Array.from(new Set(students.map(s=>s.sem))).sort();
  const ysel = document.getElementById('yearFilter');
  years.forEach(y=>ysel.insertAdjacentHTML('beforeend', `<option value="${y}">${y}</option>`));
  const ssel = document.getElementById('semFilter');
  sems.forEach(s=>ssel.insertAdjacentHTML('beforeend', `<option value="${s}">${s}</option>`));

  // initial render chunk
  renderChunk();

  // fetch initial global counts for visible chunk and beyond
  fetchCountsForAll();

  // event handlers
  document.getElementById('filterMode').addEventListener('change', applyFilters);
  document.getElementById('yearFilter').addEventListener('change', applyFilters);
  document.getElementById('semFilter').addEventListener('change', applyFilters);
  document.getElementById('reloadBtn').addEventListener('click', fetchCountsForAll);

  window.addEventListener('scroll', onScroll);
  window.addEventListener('scroll', ()=>{
    document.getElementById('scrollTopBtn').style.display = (window.scrollY>300)?'block':'none';
  });
}

function createCard(s) {
  const likeId = `like-count-${s.id}`;
  const disId = `dis-count-${s.id}`;

  const html = `
  <div class="card" data-id="${s.id}" data-year="${s.year}" data-sem="${s.sem}">
    <img class="photo" loading="lazy" src="${s.photo || ''}" alt="photo">
    <div class="signature"><img src="${s.signature || ''}" alt="sig" style="height:44px;object-fit:contain"></div>
    <div class="info">
      <div><span class="badge">Year</span> ${s.year} &nbsp; <span class="badge">Sem</span> ${s.sem}</div>
      <div style="margin-top:8px" class="likebar">
        <button class="icon" onclick="sendLike('${s.id}',1)">üëç</button>
        <div id="${likeId}">0</div>
        <button class="icon" onclick="sendLike('${s.id}',-1)">üëé</button>
        <div id="${disId}">0</div>
      </div>
    </div>
  </div>`;
  return html;
}

function renderChunk() {
  const container = document.getElementById('container');
  const to = Math.min(rendered + CHUNK, students.length);
  for (let i = rendered; i < to; i++) {
    container.insertAdjacentHTML('beforeend', createCard(students[i]));
  }
  rendered = to;
}

function onScroll() {
  if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600)) {
    renderChunk();
  }
}

async function fetchCountsForAll() {
  const ids = students.map(s=>s.id);
  const batchSize = 200;
  for (let i=0;i<ids.length;i+=batchSize) {
    const sub = ids.slice(i,i+batchSize);
    try {
      const res = await fetch(GS_WEBAPP_URL + '?action=getCounts', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ids: sub})
      });
      if (!res.ok) continue;
      const j = await res.json();
      if (j.counts) {
        Object.assign(counts, j.counts);
        sub.forEach(id => {
          const likeDom = document.getElementById(`like-count-${id}`);
          const disDom = document.getElementById(`dis-count-${id}`);
          if (likeDom) likeDom.innerText = j.counts[id]?.likes ?? 0;
          if (disDom) disDom.innerText = j.counts[id]?.dislikes ?? 0;
        });
      }
    } catch(e){ console.warn('count fetch err', e); }
  }
}

async function sendLike(id, delta) {
  const likeDom = document.getElementById(`like-count-${id}`);
  const disDom = document.getElementById(`dis-count-${id}`);
  if (delta === 1) {
    if (likeDom) likeDom.innerText = parseInt(likeDom.innerText||0)+1;
  } else {
    if (disDom) disDom.innerText = parseInt(disDom.innerText||0)+1;
  }

  try {
    const res = await fetch(GS_WEBAPP_URL + '?action=updateCount', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id: id, type: delta===1?'like':'dislike', token: WRITE_TOKEN })
    });
    if (!res.ok) return;
    const j = await res.json();
    if (j && j.ok && j.counts) {
      if (likeDom && typeof j.counts.likes !== 'undefined') likeDom.innerText = j.counts.likes;
      if (disDom && typeof j.counts.dislikes !== 'undefined') disDom.innerText = j.counts.dislikes;
    }
  } catch(err) { console.warn('update fail', err); }
}

function applyFilters() {
  const year = document.getElementById('yearFilter').value;
  const sem = document.getElementById('semFilter').value;
  const mode = document.getElementById('filterMode').value;

  let filtered = students.filter(s=> (year===""||s.year===year) && (sem===""||s.sem===sem) );

  if (mode === 'most-liked') {
    filtered.sort((a,b) => (counts[b.id]?.likes || 0) - (counts[a.id]?.likes || 0));
  } else if (mode === 'most-disliked') {
    filtered.sort((a,b) => (counts[b.id]?.dislikes || 0) - (counts[a.id]?.dislikes || 0));
  } else {
    filtered = filtered.sort(()=>Math.random()-0.5);
  }

  const container = document.getElementById('container');
  container.innerHTML = '';
  rendered = 0;
  // keep filtered as the student list to render (so renderChunk works)
  students = filtered.concat(students.filter(s=>!filtered.includes(s)));
  renderChunk();
  fetchCountsForAll();
}

init();
</script>
</body>
</html>
